From fe27530acd62739c25e8de6ce32c34a4835496bb Mon Sep 17 00:00:00 2001
From: Angie Wang <angie.Wang@windriver.com>
Date: Wed, 15 Feb 2017 15:59:26 -0500
Subject: [PATCH 1/2] modify-aodh-api

Signed-off-by: Hayde Martinez <hayde.martinez.landa@intel.com>
---
 aodh/api/aodh-api.py |  6 ++++++
 aodh/api/app.py      | 35 ++++++++++++++++++-----------------
 2 files changed, 24 insertions(+), 17 deletions(-)
 create mode 100644 aodh/api/aodh-api.py

diff --git a/aodh/api/aodh-api.py b/aodh/api/aodh-api.py
new file mode 100644
index 0000000..2cff0ec
--- /dev/null
+++ b/aodh/api/aodh-api.py
@@ -0,0 +1,6 @@
+from aodh.api import app as build_wsgi_app
+import sys
+
+sys.argv = sys.argv[:1]
+args = {'config_file' : 'etc/aodh/aodh.conf', }
+application = build_wsgi_app.build_wsgi_app(None, args)
diff --git a/aodh/api/app.py b/aodh/api/app.py
index b7c0900..928aeba 100644
--- a/aodh/api/app.py
+++ b/aodh/api/app.py
@@ -53,28 +53,28 @@ def setup_app(root, conf):
     )
 
 
-def load_app(conf):
-    global APPCONFIGS
+def load_app(conf, args):
 
     # Build the WSGI app
+    cfg_file = None
     cfg_path = conf.api.paste_config
+
     if not os.path.isabs(cfg_path):
-        cfg_path = conf.find_file(cfg_path)
+        cfg_file = conf.find_file(cfg_path)
+    elif os.path.exists(cfg_path):
+        cfg_file = cfg_path
 
-    if cfg_path is None or not os.path.exists(cfg_path):
-        raise cfg.ConfigFilesNotFoundError([conf.api.paste_config])
+    if not cfg_file:
+        raise cfg.ConfigFilesNotFoundError([conf.api. paste_config])
 
-    config = dict(conf=conf)
-    configkey = str(uuid.uuid4())
-    APPCONFIGS[configkey] = config
+    config = dict([(key, value) for key, value in args.iteritems()
+                   if key in conf and value is not None])
+    for key, value in config.iteritems():
+        if key == 'config_file':
+            conf.config_file = value
 
-    LOG.info("WSGI config used: %s", cfg_path)
-    return deploy.loadapp("config:" + cfg_path,
-                          name="aodh+" + (
-                              conf.api.auth_mode
-                              if conf.api.auth_mode else "noauth"
-                          ),
-                          global_conf={'configkey': configkey})
+     LOG.info(_LI("Full WSGI config used: %s"), cfg_file)
+     return deploy.loadapp("config:" + cfg_file)
 
 
 def app_factory(global_config, **local_conf):
@@ -83,5 +83,6 @@ def app_factory(global_config, **local_conf):
     return setup_app(root=local_conf.get('root'), **appconfig)
 
 
-def build_wsgi_app(argv=None):
-    return load_app(service.prepare_service(argv=argv))
+
+def build_wsgi_app(argv=None, args=None):
+    return load_app(service.prepare_service(argv=argv), args)
-- 
2.7.4

