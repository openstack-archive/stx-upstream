From 03566a01ac1ac1cae6f1951610918fc55c685e31 Mon Sep 17 00:00:00 2001
From: Ovidiu Poncea <ovidiu.poncea@windriver.com>
Date: Thu, 23 Aug 2018 18:33:26 +0300
Subject: [PATCH 04/18] cinder: Enable external ceph

---
 glance/templates/bin/_storage-init.sh.tpl | 7 ++++++-
 1 file changed, 6 insertions(+), 1 deletion(-)

diff --git a/glance/templates/bin/_storage-init.sh.tpl b/glance/templates/bin/_storage-init.sh.tpl
index 4082c52..5b17ce5 100644
--- a/glance/templates/bin/_storage-init.sh.tpl
+++ b/glance/templates/bin/_storage-init.sh.tpl
@@ -50,7 +50,12 @@ elif [ "x$STORAGE_BACKEND" == "xrbd" ]; then
   }
   ensure_pool "${RBD_POOL_NAME}" "${RBD_POOL_CHUNK_SIZE}" "glance-image"
 
-  if USERINFO=$(ceph auth get "client.${RBD_POOL_USER}"); then
+  set +e
+  USERINFO=$(ceph auth get "client.${RBD_POOL_USER}")
+  RET=$?
+  set -e
+  
+  if [ $RET -eq 0 ]; then
     KEYSTR=$(echo "${USERINFO}" | sed 's/.*\( key = .*\) caps mon.*/\1/')
     echo "${KEYSTR}" > "${KEYRING}"
   else
-- 
1.8.3.1

